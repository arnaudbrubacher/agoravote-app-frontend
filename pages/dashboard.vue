<template>
  <div class="container mx-auto p-6 space-y-6">
    <!-- Profile Card -->
    <Card class="w-full max-w-2xl mx-auto">
      <CardContent class="p-6">
        <div class="flex items-start space-x-6">
          <div class="flex-1 space-y-2 py-2">
            <h3 class="text-lg font-medium">{{ userName || 'Loading...' }}</h3>
            <p class="text-sm text-muted-foreground">{{ userEmail || 'Loading...' }}</p>
          </div>
          <div class="flex items-center ml-auto space-x-2">
            <Button 
              variant="outline" 
              @click="logout"
              class="flex items-center"
            >
              <LogOutIcon class="mr-2 h-4 w-4" />
              Log Out
            </Button>
            <Button 
              variant="destructive" 
              @click="deleteAccount"
              class="flex items-center"
            >
              <TrashIcon class="mr-2 h-4 w-4" />
              Delete Account
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>

    <!-- Groups Card -->
    <Card class="w-full max-w-2xl mx-auto">
      <CardHeader class="flex flex-row items-center justify-between">
        <div>
          <CardTitle>Your Groups</CardTitle>
          <CardDescription>Groups you've created or joined</CardDescription>
        </div>
        <Button @click="openNewGroupDialog" class="flex items-center ml-auto">
          <PlusIcon class="mr-2 h-4 w-4" />
          Create Group
        </Button>
      </CardHeader>
      <CardContent class="p-6">
        <!-- Add this new section for the groups list -->
        <div class="space-y-4">
          <div v-if="groups.length === 0" class="text-center py-6 text-muted-foreground">
            No groups yet. Create your first group!
          </div>
          
          <div 
            v-for="group in groups" 
            :key="group.id" 
            class="cursor-pointer"
            @click="viewGroup(group.id)"
          >
            <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-accent/50 transition-colors">
              <div class="flex items-center space-x-4">
                <div v-if="group.picture" class="w-12 h-12 rounded-full overflow-hidden">
                  <img :src="group.picture" :alt="group.name" class="w-full h-full object-cover" />
                </div>
                <div v-else class="w-12 h-12 rounded-full bg-muted flex items-center justify-center">
                  <UserGroupIcon class="h-6 w-6 text-muted-foreground" />
                </div>
                
                <div>
                  <h4 class="font-medium">{{ group.name }}</h4>
                  <p class="text-sm text-muted-foreground">{{ group.description }}</p>
                </div>
              </div>
              
              <div class="flex items-center space-x-2">
                <Button variant="outline" size="sm" @click="viewGroup(group.id)">
                  View
                </Button>
                <Button 
                  v-if="group.isPrivate" 
                  variant="secondary" 
                  size="sm"
                >
                  Private
                </Button>
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>

    <!-- Find a Group Card -->
    <Card class="w-full max-w-2xl mx-auto">
      <CardHeader class="flex flex-row items-center justify-between">
        <div>
          <CardTitle>Find a Group</CardTitle>
          <CardDescription>Search for public groups to join</CardDescription>
        </div>
      </CardHeader>
      <CardContent class="p-6">
        <div class="space-y-4">
          <!-- Search Input -->
          <div class="relative">
            <SearchIcon class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <input
              v-model="searchQuery"
              type="text"
              placeholder="Search for groups..."
              class="w-full pl-10 pr-4 py-2 border rounded-md"
              @input="debounceSearch"
            />
          </div>

          <!-- Loading State -->
          <div v-if="searchLoading" class="text-center py-4">
            <SpinnerIcon class="h-6 w-6 animate-spin mx-auto text-muted-foreground" />
            <span class="text-sm text-muted-foreground mt-2 block">Searching...</span>
          </div>

          <!-- Results -->
          <div v-else-if="searchResults.length" class="space-y-3">
            <div 
              v-for="group in searchResults" 
              :key="group.id" 
              class="flex items-center justify-between p-4 border rounded-lg hover:bg-accent/50 transition-colors"
            >
              <div class="flex items-center space-x-4">
                <div v-if="group.picture" class="w-12 h-12 rounded-full overflow-hidden">
                  <img :src="group.picture" :alt="group.name" class="w-full h-full object-cover" />
                </div>
                <div v-else class="w-12 h-12 rounded-full bg-muted flex items-center justify-center">
                  <UserGroupIcon class="h-6 w-6 text-muted-foreground" />
                </div>
                
                <div>
                  <h4 class="font-medium">{{ group.name }}</h4>
                  <p class="text-sm text-muted-foreground">{{ group.description }}</p>
                </div>
              </div>
              
              <div class="flex items-center space-x-2">
                <Button variant="outline" size="sm" @click="viewGroup(group.id)">
                  View
                </Button>
                <Button 
                  v-if="!userInGroup(group.id)"
                  variant="default" 
                  size="sm"
                  @click="joinGroup(group.id)"
                >
                  Join
                </Button>
                <Button 
                  v-else
                  variant="secondary" 
                  size="sm"
                  disabled
                >
                  Joined
                </Button>
              </div>
            </div>
          </div>

          <!-- No Results -->
          <div v-else-if="searchQuery && !searchLoading" class="text-center py-4 text-muted-foreground">
            No groups found matching your search
          </div>

          <!-- Initial State -->
          <div v-else-if="!searchQuery" class="text-center py-4 text-muted-foreground">
            Type to search for public groups
          </div>
        </div>
      </CardContent>
    </Card>

    <!-- New Group Dialog -->
    <NewGroupDialog
      v-if="showNewGroupDialog"
      @close="closeNewGroupDialog"
      @group-created="handleGroupCreated"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import axios from '~/src/utils/axios'
import { LogOutIcon, TrashIcon, PlusIcon, SearchIcon, Loader2 as SpinnerIcon } from 'lucide-vue-next'
import { UserGroupIcon } from '@heroicons/vue/outline'  // Keep only this import
import { Button } from '@/components/ui/button'
import { 
  Card, 
  CardHeader, 
  CardTitle, 
  CardDescription, 
  CardContent 
} from '@/components/ui/card'
import NewGroupDialog from '@/components/NewGroupDialog.vue'  // Make sure .vue extension is included

const router = useRouter()

const userName = ref('')
const userEmail = ref('')
const profilePicture = ref(null)
const showNewGroupDialog = ref(false)
const groups = ref([])

const fetchUserInfo = async () => {
  try {
    // Get token and userId from localStorage
    const token = localStorage.getItem('token')
    const userId = localStorage.getItem('userId')
    
    if (!token || !userId) {
      throw new Error('Authentication credentials not found')
    }

    // Make API call to get user profile
    const response = await axios.get(`/user/profile/${userId}`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })

    // Update user information from API response
    userName.value = response.data.name
    userEmail.value = response.data.email
    profilePicture.value = response.data.profilePicture || null

    console.log('User profile fetched:', response.data) // Debug log
  } catch (error) {
    console.error('Failed to fetch user info:', error)
    if (error.response?.status === 401) {
      // Handle unauthorized access
      localStorage.removeItem('token')
      localStorage.removeItem('userId')
      router.push('/auth')
    }
  }
}

const fetchGroups = async () => {
    try {
        const token = localStorage.getItem('token')
        if (!token) {
            throw new Error('No authentication token found')
        }

        const response = await axios.get('/user/groups', {
            headers: {
                Authorization: `Bearer ${token}`
            }
        })

        groups.value = response.data
        console.log('User groups fetched:', response.data)
    } catch (error) {
        console.error('Failed to fetch user groups:', error)
        if (error.response?.status === 401) {
            router.push('/auth')
        }
    }
}

const viewGroup = (groupId) => {
    console.log('Navigating to group:', groupId)
    // Fix: Only use path, not path + params
    router.push(`/group/${groupId}`)
}

onMounted(() => {
  fetchUserInfo()
  fetchGroups()
})

const triggerFileInput = () => {
  fileInput.value.click()
}

const updateProfilePicture = (event) => {
  const file = event.target.files[0]
  if (file) {
    const reader = new FileReader()
    reader.onload = (e) => {
      profilePicture.value = e.target.result
    }
    reader.readAsDataURL(file)
  }
}

const logout = () => {
  // Clear user session or token
  localStorage.removeItem('token')
  router.push('/auth')
}

const deleteAccount = async () => {
  try {
    const userId = localStorage.getItem('userId') // Assuming userId is stored in localStorage
    await axios.delete(`/user/${userId}`)
    localStorage.removeItem('token')
    localStorage.removeItem('userId')
    router.push('/auth')
  } catch (error) {
    console.error('Failed to delete account:', error)
  }
}

// Dialog handlers
const openNewGroupDialog = () => {
  showNewGroupDialog.value = true
}

const closeNewGroupDialog = () => {
  showNewGroupDialog.value = false
}

const handleGroupCreated = async (newGroup) => {
  await fetchGroups() // Refresh the entire list
  closeNewGroupDialog()
}

// For search functionality
const searchQuery = ref('')
const searchResults = ref([])
const searchLoading = ref(false)
const searchTimeout = ref(null)

// Debounce search to prevent too many API calls
const debounceSearch = () => {
  if (searchTimeout.value) {
    clearTimeout(searchTimeout.value)
  }
  
  searchTimeout.value = setTimeout(() => {
    searchGroups()
  }, 500)
}

// Search for public groups
const searchGroups = async () => {
  if (!searchQuery.value.trim()) {
    searchResults.value = []
    return
  }
  
  try {
    searchLoading.value = true
    const response = await axios.get(`/groups/search?query=${encodeURIComponent(searchQuery.value)}`)
    searchResults.value = response.data
    console.log('Search results:', response.data)
  } catch (error) {
    console.error('Failed to search groups:', error)
    searchResults.value = []
  } finally {
    searchLoading.value = false
  }
}

// Check if user is already in a group
const userInGroup = (groupId) => {
  return groups.value.some(group => group.id === groupId)
}

// Join a group
const joinGroup = async (groupId) => {
  try {
    await axios.post(`/groups/${groupId}/join`)
    // Refresh user groups after joining
    await fetchGroups()
    // Show success message or notification
    alert('Successfully joined the group!')
  } catch (error) {
    console.error('Failed to join group:', error)
    // Show error message
    alert('Failed to join group: ' + (error.response?.data?.message || 'Unknown error'))
  }
}
</script>

<style>
/* Your styles here */
</style>